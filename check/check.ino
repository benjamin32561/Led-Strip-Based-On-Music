#include "FFT.h" // include the library

#define FFT_N 2048 // Must be a power of 2
#define SAMPLING_FREQ 44100

float total_time = FFT_N*1.0/SAMPLING_FREQ;
float fft_input[FFT_N];
float fft_output[FFT_N];

float max_magnitude = 0;
float fundamental_freq = 0;

double fft_signal[FFT_N] = {
  0,22427,6527,-20528,-12503,16889,17418,-11821,-20858,5750,22530,808,-22296,-7297,20172,13167,-16341,-17923,11124,21161,-4966,-22606,-1613,22135,8056,-19792,-13816,15771,18407,-10414,-21437,4175,22651,2418,-21947,-8806,19385,14447,-15181,-18865,9690,21686,-3379,-22669,-3219,21732,9544,-18955,-15060,14571,19301,-8954,-21906,2578,22658,4016,-21489,-10271,18500,15654,-13943,-19713,8207,22100,-1775,-22617,-4808,21218,10983,-18021,-16228,13298,20098,-7450,-22266,969,22549,5593,-20921,-11682,17521,16782,-12636,-20459,6682,22404,-162,-22451,-6372,20596,12368,-16997,-17314,11958,20794,-5906,-22513,-646,22324,7143,-20246,-13036,16452,17825,-11264,-21103,5124,22593,1453,-22170,-7904,19869,13688,-15886,-18312,10558,21384,-4333,-22645,-2258,21988,8656,-19468,-14323,15300,18776,-9836,-21638,3538,22668,3059,-21778,-9398,19043,14940,-14695,-19217,9102,21866,-2738,-22662,-3857,21540,10126,-18593,-15536,14071,19632,-8356,-22065,1936,22628,4650,-21274,-10841,18120,16115,-13428,-20023,7602,22236,-1130,-22565,-5437,20982,11543,-17622,-16673,12770,20389,-6837,-22379,322,22473,6218,-20663,-12231,17103,17210,-12095,-20729,6062,22493,484,-22353,-6990,20317,12903,-16563,-17724,11404,21042,-5280,-22580,-1291,22204,7754,-19947,-13559,16001,18216,-10700,-21330,4491,22636,2096,-22027,-8508,19551,14197,-15419,-18684,9981,21589,-3698,-22666,-2899,21822,9250,-19130,-14818,14818,19129,-9250,-21822,2899,22665,3698,-21589,-9981,18684,15419,-14197,-19551,8506,22027,-2096,-22637,-4492,21330,10699,-18215,-16000,13559,19947,-7753,-22203,1291,22580,5281,-21042,-11404,17723,16563,-12903,-20317,6990,22352,-484,-22494,-6062,20730,12095,-17208,-17104,12231,20664,-6217,-22473,-323,22379,6836,-20389,-12770,16672,17622,-11544,-20983,5437,22565,1130,-22236,-7602,20023,13429,-16115,-18119,10841,21274,-4650,-22628,-1936,22064,8357,-19632,-14071,15537,18593,-10126,-21540,3856,22662,2739,-21865,-9102,19216,14694,-14939,-19042,9397,21777,-3059,-22667,-3539,21638,9836,-18776,-15301,14322,19469,-8657,-21989,2257,22645,4333,-21384,-10557,18312,15886,-13687,-19870,7905,22170,-1453,-22593,-5122,21102,11264,-17823,-16451,13036,20246,-7143,-22325,646,22512,5905,-20794,-11958,17313,16997,-12367,-20596,6372,22451,161,-22404,-6682,20460,12637,-16781,-17521,11681,20920,-5593,-22548,-968,22267,7449,-20098,-13299,16228,18022,-10983,-21218,4807,22617,1774,-22101,-8206,19712,13943,-15654,-18500,10269,21489,-4016,-22658,-2578,21907,8955,-19302,-14571,15060,18955,-9544,-21733,3219,22669,3379,-21686,-9691,18865,15181,-14448,-19385,8805,21948,-2417,-22652,-4175,21437,10414,-18407,-15770,13815,19791,-8056,-22136,1613,22605,4966,-21161,-11125,17923,16340,-13167,-20173,7296,22296,-806,-22532,-5750,20858,11821,-17418,-16890,12502,20527,-6528,-22428,0,22429,6528,-20528,-12503,16889,17417,-11820,-20859,5751,22531,807,-22296,-7297,20173,13168,-16340,-17923,11124,21161,-4966,-22605,-1613,22136,8056,-19791,-13816,15770,18406,-10413,-21437,4174,22652,2417,-21948,-8805,19385,14447,-15181,-18865,9690,21686,-3378,-22669,-3219,21733,9544,-18954,-15060,14572,19301,-8954,-21907,2578,22658,4016,-21489,-10270,18500,15654,-13944,-19712,8207,22101,-1775,-22617,-4809,21218,10983,-18021,-16228,13298,20098,-7450,-22266,969,22548,5595,-20921,-11683,17521,16782,-12636,-20459,6682,22403,-162,-22452,-6372,20596,12366,-16997,-17313,11958,20793,-5906,-22512,-646,22325,7143,-20246,-13036,16452,17823,-11264,-21102,5123,22593,1453,-22171,-7904,19869,13688,-15887,-18311,10557,21384,-4333,-22646,-2256,21987,8657,-19468,-14323,15300,18775,-9836,-21639,3538,22668,3059,-21778,-9397,19044,14940,-14695,-19217,9102,21865,-2739,-22661,-3857,21540,10126,-18593,-15537,14071,19633,-8357,-22065,1936,22627,4650,-21274,-10842,18119,16115,-13429,-20023,7602,22236,-1130,-22564,-5437,20982,11544,-17623,-16672,12770,20388,-6835,-22378,323,22473,6217,-20663,-12231,17104,17209,-12095,-20729,6062,22494,485,-22352,-6989,20317,12904,-16563,-17723,11404,21042,-5280,-22579,-1291,22203,7753,-19948,-13558,16001,18215,-10699,-21330,4492,22636,2096,-22026,-8507,19551,14197,-15420,-18685,9981,21590,-3698,-22666,-2899,21822,9250,-19129,-14817,14818,19129,-9250,-21822,2900,22665,3697,-21590,-9981,18684,15418,-14197,-19551,8507,22027,-2096,-22637,-4492,21330,10700,-18216,-16001,13559,19947,-7753,-22204,1292,22579,5281,-21043,-11405,17723,16563,-12903,-20318,6990,22352,-484,-22493,-6062,20729,12095,-17209,-17104,12230,20663,-6218,-22472,-322,22378,6836,-20389,-12769,16672,17622,-11544,-20982,5438,22565,1130,-22236,-7602,20023,13429,-16115,-18119,10842,21274,-4651,-22628,-1935,22065,8358,-19633,-14071,15538,18593,-10125,-21540,3857,22663,2738,-21865,-9102,19215,14695,-14940,-19043,9398,21778,-3059,-22667,-3537,21638,9837,-18776,-15301,14322,19469,-8656,-21988,2258,22645,4334,-21384,-10556,18312,15886,-13687,-19870,7905,22170,-1452,-22593,-5123,21102,11265,-17824,-16452,13036,20246,-7143,-22325,646,22512,5906,-20795,-11958,17313,16998,-12366,-20597,6372,22451,161,-22403,-6682,20460,12636,-16781,-17520,11682,20921,-5594,-22548,-968,22267,7449,-20098,-13298,16228,18022,-10983,-21218,4808,22617,1775,-22100,-8207,19712,13944,-15655,-18499,10270,21489,-4016,-22657,-2579,21907,8953,-19301,-14571,15061,18955,-9544,-21733,3220,22669,3379,-21687,-9690,18866,15181,-14448,-19386,8805,21948,-2418,-22652,-4175,21437,10413,-18405,-15770,13817,19791,-8055,-22136,1613,22605,4966,-21161,-11124,17923,16340,-13167,-20172,7296,22296,-808,-22531,-5750,20858,11821,-17418,-16890,12502,20528,-6526,-22428,0,22428,6527,-20529,-12502,16890,17418,-11821,-20858,5750,22532,807,-22296,-7296,20172,13167,-16341,-17923,11124,21161,-4966,-22605,-1614,22136,8056,-19792,-13816,15771,18406,-10414,-21436,4175,22652,2417,-21949,-8805,19385,14447,-15181,-18866,9691,21686,-3378,-22670,-3219,21733,9544,-18954,-15061,14572,19301,-8953,-21907,2579,22658,4017,-21489,-10270,18500,15654,-13944,-19712,8207,22102,-1775,-22617,-4808,21218,10983,-18022,-16228,13298,20098,-7450,-22266,968,22548,5594,-20921,-11683,17520,16781,-12636,-20459,6682,22404,-161,-22451,-6372,20596,12367,-16997,-17313,11958,20794,-5906,-22513,-646,22325,7143,-20245,-13035,16452,17824,-11265,-21102,5123,22594,1453,-22171,-7906,19870,13687,-15886,-18312,10557,21384,-4334,-22644,-2258,21988,8657,-19469,-14322,15300,18776,-9835,-21639,3538,22668,3058,-21778,-9397,19043,14939,-14695,-19216,9103,21865,-2739,-22663,-3857,21540,10126,-18593,-15537,14071,19633,-8357,-22064,1936,22627,4651,-21274,-10842,18119,16115,-13429,-20024,7602,22236,-1130,-22564,-5438,20983,11544,-17622,-16672,12769,20390,-6836,-22379,323,22473,6218,-20662,-12232,17103,17209,-12094,-20728,6062,22494,485,-22352,-6990,20318,12903,-16563,-17724,11404,21043,-5280,-22579,-1292,22204,7753,-19947,-13559,16001,18215,-10700,-21329,4491,22637,2096,-22027,-8506,19551,14196,-15419,-18684,9981,21590,-3698,-22665,-2900,21823,9249,-19130,-14817,14817,19130,-9250,-21822,2899,22666,3698,-21589,-9981,18685,15419,-14197,-19551,8507,22026,-2096,-22636,-4493,21329,10700,-18216,-16001,13558,19947,-7753,-22203,1292,22579,5280,-21042,-11404,17723,16562,-12903,-20318,6989,22353,-484,-22493,-6061,20728,12095,-17209,-17104,12232,20662,-6217,-22472,-323,22378,6835,-20389,-12771,16672,17622,-11544,-20982,5437,22565,1130,-22236,-7601,20023,13429,-16116,-18119,10841,21274,-4650,-22628,-1936,22065,8358,-19632,-14071,15537,18593,-10126,-21540,3857,22663,2738,-21866,-9102,19216,14695,-14939,-19043,9397,21777,-3059,-22668,-3539,21638,9836,-18776,-15300,14322,19468,-8656,-21988,2258,22645,4334,-21384,-10556,18310,15887,-13688,-19871,7904,22170,-1452,-22593,-5123,21103,11264,-17824,-16452,13036,20246,-7143,-22326,646,22513,5907,-20794,-11958,17314,16997,-12367,-20597,6373,22451,162,-22403,-6682,20458,12636,-16782,-17520,11683,20921,-5594,-22548,-969,22267,7448,-20099,-13298,16228,18022,-10983,-21218,4807,22618,1775,-22100,-8206,19712,13944,-15654,-18501,10270,21489,-4016,-22657,-2578,21907,8954,-19301,-14571,15060,18955,-9544,-21732,3218,22668,3380,-21686,-9690,18865,15180,-14448,-19385,8806,21949,-2418,-22651,-4175,21437,10413,-18406,-15770,13815,19791,-8056,-22136,1614,22606,4966,-21161,-11124,17923,16341,-13167,-20173,7297,22297,-807,-22532,-5750,20857,11820,-17418,-16890,12501,20528,-6528,-22428,0,22428,6527,-20529,-12502,16890,17417,-11821,-20858,5750,22531,808,-22296,-7296,20173,13167,-16341,-17923,11124,21160,-4966,-22606,-1614,22137,8056,-19792,-13816,15770,18407,-10414,-21437,4175,22652,2417,-21948,-8806,19386,14448,-15181,-18865,9690,21686,-3378,-22669,-3219,21733,9544,-18954,-15060,14571,19301,-8954,-21908,2578,22658,4015,-21488,-10271,18499,15655,-13944,-19712,8207,22101,-1775,-22618,-4808,21218,10983,-18021,-16229,13299,20098,-7449,-22266,969,22548,5594,-20921,-11683,17521,16782,-12636,-20459,6682,22404,-161,-22450,-6373,20597,12367,-16997,-17313,11958,20794,-5906,-22512,-646,22325,7143,-20246,-13036,16452,17824,-11265,-21103,5124,22593,1453,-22170,-7905,19871,13688,-15886,-18311,10557,21384,-4334,-22644,-2257,21988,8657,-19469,-14322,15300,18776,-9836,-21637,3538,22668,3059,-21778,-9397,19043,14940,-14695,-19216,9103,21865,-2739,-22662,-3857,21540,10126,-18592,-15536,14071,19633,-8357,-22064,1935,22628,4649,-21274,-10842,18119,16115,-13429,-20024,7601,22235,-1131,-22564,-5438,20982,11544,-17622,-16672,12770,20389,-6836,-22379,323,22473,6218,-20662,-12232,17103,17209,-12095,-20729,6062,22494,485,-22352,-6990,20318,12904,-16563,-17723,11405,21042,-5281,-22579,-1291,22203,7753,-19947,-13559,16001,18215,-10700,-21329,4491,22637,2097,-22027,-8507,19551,14198,-15420,-18685,9981,21590,-3697,-22666,-2899,21822,9250,-19130,-14817,14818,19131,-9249,-21822,2898,22665,3698,-21589,-9982,18685,15419,-14197,-19551,8507,22027,-2096,-22637,-4492,21330,10699,-18216,-16001,13558,19947,-7753,-22203,1291,22579,5280,-21042,-11404,17724,16564,-12903,-20319,6990,22352,-484,-22494,-6062,20729,12095,-17209,-17103,12231,20663,-6218,-22473,-323,22378,6836,-20389,-12770,16673,17622,-11544,-20981,5437,22565,1130,-22235,-7601,20023,13429,-16115,-18119,10841,21273,-4650,-22627,-1936,22064,8358,-19632,-14071,15537,18592,-10126,-21541,3857,22663,2738,-21865,-9103,19216,14695,-14939,-19043,9397,21777,-3059,-22669,-3538,21638,9836,-18776,-15300,14323,19468,-8656,-21988,2257,22645,4334,-21383,-10556,18311,15886,-13687,-19870,7905,22171,-1453,-22593,-5123,21102,11265,-17824,-16452,13036,20246,-7143,-22326,646,22513,5907,-20794,-11959,17313,16997,-12367,-20595,6373,22451,162,-22404,-6682,20459,12636,-16781,-17520,11682,20921,-5594,-22548,-968,22267,7449,-20099,-13299,16229,18022,-10983,-21217,4808,22617,1775,-22101,-8207,19712,13943,-15655,-18500,10270,21489,-4016,-22658,-2578,21907,8954,-19301,-14571,15060,18954,-9543,-21732,3219,22669,3379,-21686,-9691,18866,15181,-14447,-19385,8805,21949,-2417,-22652,-4176,21437,10414,-18406,-15771,13815,19792,-8056,-22136,1613,22606,4965,-21161,-11124,17923,16341,-13168,-20173,7296,22296,-807,-22531,-5750,20858,11820,-17418,-16890,12501,20528,-6527,-22428,0,22429,6528,-20528,-12502,16890,17418,-11821,-20858,5751,22531,808,-22297,-7297,20173,13168,-16341,-17923,11124,21161,-4966,-22607,-1613,22136,8056,-19791,-13816,15770,18406,-10414,-21437,4175,22652,2418,-21948,-8805,19385,14448,-15181,-18865,9690,21686,-3379,-22668,-3219,21732,9544,-18955,-15061,14572,19301,-8955,-21907,2579,22658,4015,-21489,-10270,18500,15655,-13944,-19712,8206,22100,-1774,-22616,-4808,21217,10983,-18022,-16228,13298,20098,-7449,-22267,969,22548,5594,-20920,-11682,17520,16782,-12636,-20459,6681,22403,-161,-22451,-6373,20596,12366,-16997,-17313,11958,20793,-5907,-22513,-647,22325,7142,-20246,-13036,16452,17824,-11265,-21102,5123,22592,1452,-22171,-7905,19870,13688,-15886,-18312,10557,21384,-4333,-22645,-2257,21988,8657,-19468,-14322,15300,18776,-9836,-21638,3539,22668,3059,-21777,-9398,19043,14939,-14695,-19216,9102,21865,-2739,-22662,-3856,21539,10126,-18592,-15537,14071,19633,-8357,-22064,1936,22628,4650,-21275,-10842,18119,16115,-13429,-20023,7601,22236,-1130,-22565,-5438,20982,11543,-17622,-16672,12770,20389,-6837,-22379,323,22473,6217,-20663,-12231,17103,17208,-12095,-20729,6062,22493,485,-22352,-6989,20318,12903,-16563,-17724,11405,21043,-5280,-22579,-1292,22203,7754,-19947,-13558,16001,18215,-10699,-21329,4492,22636,2097,-22026,-8507,19551,14197,-15419,-18684,9981,21589,-3698,-22666,-2898,21823,9250,-19130,-14817,14817,19130,-9250,-21822,2899,22665,3697,-21589,-9981,18684,15420,-14196,-19550,8507,22027,-2097,-22636,-4492,21330,10700,-18215,-16001,13559,19947,-7753,-22203,1292,22579,5281,-21043,-11404,17724,16563,-12903,-20318,6989,22353,-485,-22493,-6062,20730,12094,-17209,-17103,12231,20663,-6218,-22472,-323,22379,6836,-20390,-12770,16672,17623,-11543,-20981,5437,22564,1129,-22236,-7602,20024
};

fft_config_t* real_fft_plan = fft_init(FFT_N, FFT_REAL, FFT_FORWARD, fft_input, fft_output);

void setup() {
  Serial.begin(115200); // use the serial port
}

void loop() {
  char print_buf[300];

  Serial.println(total_time);

  for (int k = 0 ; k < FFT_N ; k++)
    real_fft_plan->input[k] = (float)fft_signal[k];

  long int t1 = micros();
  // Execute transformation
  fft_execute(real_fft_plan);
  
  // Print the output
  for (int k = 0 ; k < real_fft_plan->size / 2 ; k++)
  {
    float mag = sqrt(pow(real_fft_plan->output[2*k],2) + pow(real_fft_plan->output[2*k+1],2));
    if(mag > max_magnitude)
    {
        max_magnitude = mag;
        fundamental_freq = k/total_time;
    }
  }
  long int t2 = micros();
  
  Serial.println();
  /*Multiply the magnitude at all other frequencies with (2/FFT_N) to obtain the amplitude at that frequency*/
  sprintf(print_buf,"Fundamental Freq : %f Hz\t Mag: %f g\n", fundamental_freq, (max_magnitude/10000)*2/FFT_N);
  Serial.println(print_buf);

  Serial.print("Time taken: ");Serial.print((t2-t1)*1.0/1000);Serial.println(" milliseconds!");
  
  // Clean up at the end to free the memory allocated
  fft_destroy(real_fft_plan);

  delay(5000);
}
